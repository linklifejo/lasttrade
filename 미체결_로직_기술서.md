# ğŸ“‹ ë¯¸ì²´ê²° ì •ë³´ë¥¼ í™œìš©í•œ ë§¤ìˆ˜/ë§¤ë„ ë¡œì§ ìƒì„¸ ê¸°ìˆ ì„œ

## ğŸ”„ **ì „ì²´ íë¦„ë„**

```
bot.py ë©”ì¸ ë£¨í”„ (5ì´ˆë§ˆë‹¤)
    â†“
1. get_outstanding_orders() í˜¸ì¶œ (1íšŒë§Œ)
    â†“
2. ë¯¸ì²´ê²° ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ íšë“
    â†“
3. check_n_sell() ì „ë‹¬ â†’ ë§¤ë„ ë¡œì§
    â†“
4. _process_watering_logic() ì „ë‹¬ â†’ ë§¤ìˆ˜ ë¡œì§
```

---

## ğŸ“ **1. ë¯¸ì²´ê²° ì •ë³´ ì¡°íšŒ** (`bot.py` Line 696)

### **ì½”ë“œ ìœ„ì¹˜**
```python
# bot.py Line 693-696
from kiwoom_adapter import get_api
api = get_api()
out_orders = await loop.run_in_executor(None, api.get_outstanding_orders, self.chat_command.token)
```

### **ë™ì‘ ì›ë¦¬**
- **í˜¸ì¶œ ì£¼ê¸°**: ë©”ì¸ ë£¨í”„ 1íšŒë‹¹ 1ë²ˆë§Œ í˜¸ì¶œ (5ì´ˆë§ˆë‹¤)
- **API ì—”ë“œí¬ì¸íŠ¸**: `kiwoom/real_api.py::get_outstanding_orders()`
- **ì¬ì‹œë„ ë¡œì§**: 3íšŒ ì¬ì‹œë„ + ì§€ìˆ˜ ë°±ì˜¤í”„ (1ì´ˆ â†’ 2ì´ˆ â†’ 4ì´ˆ)
- **ì—ëŸ¬ ì²˜ë¦¬**: Error 1700 (ìš”ì²­ ì´ˆê³¼) ë°œìƒ ì‹œ ìë™ ì¬ì‹œë„

### **ë°˜í™˜ ë°ì´í„° êµ¬ì¡°**
```python
[
    {
        'stk_cd': 'A005930',      # ì¢…ëª©ì½”ë“œ
        'ord_no': '0000123456',   # ì£¼ë¬¸ë²ˆí˜¸
        'type': 'buy',            # 'buy' or 'sell'
        'ord_tp': '01',           # '01': ë§¤ìˆ˜, '02': ë§¤ë„
        'qty': 100,               # ë¯¸ì²´ê²° ìˆ˜ëŸ‰
        'pric': 75000             # ì£¼ë¬¸ ê°€ê²©
    },
    ...
]
```

---

## ğŸ“ **2. ë§¤ë„ ë¡œì§ì—ì„œ ë¯¸ì²´ê²° í™œìš©** (`check_n_sell.py`)

### **2-1. ë§¤ë„ ì „ ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸ ì·¨ì†Œ** (Line 218-248)

#### **ëª©ì **
- ë§¤ë„ ì§ì „ì— í•´ë‹¹ ì¢…ëª©ì˜ **ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸**ì„ ì·¨ì†Œí•˜ì—¬ ì¶©ëŒ ë°©ì§€
- ì˜ˆ: ì†ì ˆ ë§¤ë„ ì¤‘ì¸ë° ë¬¼íƒ€ê¸° ë§¤ìˆ˜ê°€ ë™ì‹œì— ì²´ê²°ë˜ëŠ” ê²ƒì„ ë°©ì§€

#### **ë™ì‘ íë¦„**
```python
if should_sell:  # ë§¤ë„ ì¡°ê±´ ë§Œì¡± ì‹œ
    # 1. ë¯¸ì²´ê²° ì£¼ë¬¸ í™•ì¸
    current_orders = outstanding_orders  # bot.pyì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš©
    
    # 2. í•´ë‹¹ ì¢…ëª©ì˜ ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸ ì°¾ê¸°
    for order in current_orders:
        order_code = normalize_stock_code(order.get('stk_cd'))
        order_type = order.get('type') or order.get('ord_tp')
        
        if order_code == stock_code:
            if order_type == 'buy' or order_type == '01':
                # 3. ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸ ì·¨ì†Œ
                api.cancel_stock(stock_code, qty, ord_no, token)
                logger.info(f"[ë¯¸ì²´ê²° ì·¨ì†Œ ì™„ë£Œ] {stock_name}: ì£¼ë¬¸ë²ˆí˜¸ {ord_no}")
                time.sleep(0.5)  # ì·¨ì†Œ ë°˜ì˜ ëŒ€ê¸°
```

#### **í•µì‹¬ í¬ì¸íŠ¸**
- **API ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€**: `outstanding_orders` íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì¬ì‚¬ìš©
- **ì·¨ì†Œ í›„ ëŒ€ê¸°**: 0.5ì´ˆ ëŒ€ê¸°í•˜ì—¬ í‚¤ì›€ ì„œë²„ ë°˜ì˜ ì‹œê°„ í™•ë³´
- **ì—ëŸ¬ ì²˜ë¦¬**: ì·¨ì†Œ ì‹¤íŒ¨í•´ë„ ë§¤ë„ëŠ” ì§„í–‰ (ë¡œê·¸ë§Œ ê¸°ë¡)

---

## ğŸ“ **3. ë§¤ìˆ˜ ë¡œì§ì—ì„œ ë¯¸ì²´ê²° í™œìš©** (`check_n_buy.py`)

### **3-1. ë§¤ë„ ì¤‘ì¸ ì¢…ëª© ë§¤ìˆ˜ ê¸ˆì§€** (Line 54-58)

#### **ëª©ì **
- ë§¤ë„ ì£¼ë¬¸ì´ ì „ì†¡ëœ ì¢…ëª©ì€ **ì ˆëŒ€ ë§¤ìˆ˜ ê¸ˆì§€**
- `config.stocks_being_sold` ì„¸íŠ¸ë¡œ ê´€ë¦¬

#### **ë™ì‘ íë¦„**
```python
import config
if stk_cd in config.stocks_being_sold:
    logger.warning(f"[ë§¤ìˆ˜ ê¸ˆì§€] {stk_cd}: í˜„ì¬ ë§¤ë„ ì¤‘ì¸ ì¢…ëª©ì…ë‹ˆë‹¤.")
    return False
```

---

### **3-2. ë¯¸ì²´ê²° ë§¤ë„ ì£¼ë¬¸ í™•ì¸** (Line 72-110)

#### **ëª©ì **
- ë¯¸ì²´ê²° **ë§¤ë„ ì£¼ë¬¸**ì´ ìˆìœ¼ë©´ ë§¤ìˆ˜ ê¸ˆì§€
- ë¯¸ì²´ê²° **ë§¤ìˆ˜ ì£¼ë¬¸**ì´ ìˆìœ¼ë©´ ì·¨ì†Œ í›„ ìƒˆ ì£¼ë¬¸ (ì¤‘ë³µ ë°©ì§€)

#### **ë™ì‘ íë¦„**
```python
# 1. ë¯¸ì²´ê²° ì£¼ë¬¸ í™•ì¸
if outstanding_orders is None and token:
    from kiwoom_adapter import get_api
    api = get_api()
    outstanding_orders = api.get_outstanding_orders(token)

# 2. í•´ë‹¹ ì¢…ëª©ì˜ ë¯¸ì²´ê²° ì£¼ë¬¸ ê²€ìƒ‰
for order in outstanding_orders:
    order_code = normalize_stock_code(order.get('stk_cd'))
    order_type = order.get('type') or order.get('ord_tp')
    
    if order_code == stk_cd:
        # 3-1. ë¯¸ì²´ê²° ë§¤ë„ ì£¼ë¬¸ â†’ ë§¤ìˆ˜ ê¸ˆì§€
        if order_type == 'sell' or order_type == '02':
            logger.warning(f"[ë§¤ìˆ˜ ê¸ˆì§€] {stk_cd}: ë¯¸ì²´ê²° ë§¤ë„ ì£¼ë¬¸ ì¡´ì¬")
            return False
        
        # 3-2. ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸ â†’ ì·¨ì†Œ
        if order_type == 'buy' or order_type == '01':
            logger.warning(f"[ë¯¸ì²´ê²° ì·¨ì†Œ] {stk_cd}: ê¸°ì¡´ ë§¤ìˆ˜ ì£¼ë¬¸ ì·¨ì†Œ ì‹œë„")
            api.cancel_stock(stk_cd, qty, ord_no, token)
            time.sleep(0.5)  # ì·¨ì†Œ ë°˜ì˜ ëŒ€ê¸°
```

#### **í•µì‹¬ í¬ì¸íŠ¸**
- **ë§¤ë„ ì£¼ë¬¸ ìš°ì„ **: ë§¤ë„ ì¤‘ì´ë©´ ë¬´ì¡°ê±´ ë§¤ìˆ˜ ê¸ˆì§€
- **ë§¤ìˆ˜ ì£¼ë¬¸ ì¤‘ë³µ ë°©ì§€**: ê¸°ì¡´ ë¯¸ì²´ê²° ë§¤ìˆ˜ ì£¼ë¬¸ ì·¨ì†Œ í›„ ìƒˆ ì£¼ë¬¸
- **Fallback**: ë¯¸ì²´ê²° í™•ì¸ ì‹¤íŒ¨í•´ë„ ë§¤ìˆ˜ëŠ” ì§„í–‰ (API ì˜¤ë¥˜ ì‹œ ì°¨ë‹¨ ë°©ì§€)

---

### **3-3. ìœ ë ¹ ë§¤ë„ ëª©ë¡ ìë™ ì •ë¦¬** (Line 60-70)

#### **ëª©ì **
- `config.stocks_being_sold`ê°€ ë¹„ëŒ€í•´ì§€ëŠ” ê²ƒ ë°©ì§€
- ì‹¤ì œë¡œ ë§¤ë„ ì£¼ë¬¸ì´ ì—†ëŠ”ë° ëª©ë¡ì— ë‚¨ì•„ìˆëŠ” ì¢…ëª© ì œê±°

#### **ë™ì‘ íë¦„**
```python
import random
if random.random() < 0.05:  # 5% í™•ë¥ ë¡œ ì •ë¦¬
    # 1. ì‹¤ì œ ë¯¸ì²´ê²° ë§¤ë„ ì£¼ë¬¸ ëª©ë¡ ì¶”ì¶œ
    selling_codes = {
        normalize_stock_code(o.get('stk_cd')) 
        for o in outstanding_orders 
        if o.get('type') == 'sell' or o.get('ord_tp') == '02'
    }
    
    # 2. ìœ ë ¹ ì¢…ëª© ì°¾ê¸° (ëª©ë¡ì—ëŠ” ìˆëŠ”ë° ì‹¤ì œ ì£¼ë¬¸ì€ ì—†ìŒ)
    stuck_codes = config.stocks_being_sold - selling_codes
    
    # 3. ìœ ë ¹ ì¢…ëª© ì œê±°
    for sc in stuck_codes:
        config.stocks_being_sold.discard(sc)
        logger.info(f"[Auto Clean] {sc} ìœ ë ¹ ë§¤ë„ ëª©ë¡ì—ì„œ ì œê±°ë¨")
```

---

## ğŸ“Š **ë¯¸ì²´ê²° ì •ë³´ í™œìš© ìš”ì•½í‘œ**

| **ë‹¨ê³„** | **ìœ„ì¹˜** | **ë¯¸ì²´ê²° í™œìš©** | **ëª©ì ** |
|---------|---------|----------------|---------|
| **ì¡°íšŒ** | `bot.py:696` | 1íšŒ ì¡°íšŒ í›„ ì „ë‹¬ | API í˜¸ì¶œ ìµœì†Œí™” |
| **ë§¤ë„ ì „** | `check_n_sell.py:218` | ë¯¸ì²´ê²° ë§¤ìˆ˜ ì·¨ì†Œ | ì¶©ëŒ ë°©ì§€ |
| **ë§¤ìˆ˜ ì „** | `check_n_buy.py:72` | ë¯¸ì²´ê²° ë§¤ë„ í™•ì¸ | ë§¤ìˆ˜ ê¸ˆì§€ |
| **ë§¤ìˆ˜ ì „** | `check_n_buy.py:94` | ë¯¸ì²´ê²° ë§¤ìˆ˜ ì·¨ì†Œ | ì¤‘ë³µ ë°©ì§€ |
| **ì •ë¦¬** | `check_n_buy.py:60` | ìœ ë ¹ ëª©ë¡ ì²­ì†Œ | ë©”ëª¨ë¦¬ ê´€ë¦¬ |

---

## ğŸ”§ **API ì¬ì‹œë„ ë¡œì§** (`kiwoom/real_api.py:406-445`)

### **ì—ëŸ¬ ì²˜ë¦¬**
```python
def get_outstanding_orders(self, token):
    max_retries = 3
    retry_delay = 1.0
    
    for attempt in range(max_retries):
        try:
            response = requests.post(url, headers=headers, json=body)
            
            # ì„±ê³µ ì‹œ ë°˜í™˜
            if response.status_code == 200:
                return parsed_orders
                
        except Exception as e:
            if attempt < max_retries - 1:
                logger.warning(f"ë¯¸ì²´ê²° ì¡°íšŒ ì¬ì‹œë„ {attempt+1}/{max_retries}")
                time.sleep(retry_delay)
                retry_delay *= 2  # ì§€ìˆ˜ ë°±ì˜¤í”„
            else:
                logger.error(f"ë¯¸ì²´ê²° ì¡°íšŒ ìµœì¢… ì‹¤íŒ¨: {e}")
                return []
    
    return []
```

### **ì¬ì‹œë„ ì „ëµ**
- **1ì°¨ ì‹œë„**: ì¦‰ì‹œ
- **2ì°¨ ì‹œë„**: 1ì´ˆ ëŒ€ê¸°
- **3ì°¨ ì‹œë„**: 2ì´ˆ ëŒ€ê¸°
- **ì‹¤íŒ¨ ì‹œ**: ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (ë§¤ë§¤ ì¤‘ë‹¨ ë°©ì§€)

---

## âš ï¸ **ì£¼ì˜ì‚¬í•­**

### **1. API í˜¸ì¶œ ì œí•œ**
- **ë¬¸ì œ**: í‚¤ì›€ APIëŠ” ì´ˆë‹¹ ìš”ì²­ ì œí•œ ìˆìŒ (Error 1700)
- **í•´ê²°**: ë©”ì¸ ë£¨í”„ì—ì„œ 1íšŒë§Œ ì¡°íšŒ í›„ ì „ë‹¬

### **2. ë°ì´í„° ë™ê¸°í™”**
- **ë¬¸ì œ**: ì£¼ë¬¸ ì·¨ì†Œ í›„ ì¦‰ì‹œ ë°˜ì˜ ì•ˆ ë¨
- **í•´ê²°**: `time.sleep(0.5)` ëŒ€ê¸° ì‹œê°„ í™•ë³´

### **3. Fallback ì²˜ë¦¬**
- **ë¬¸ì œ**: ë¯¸ì²´ê²° ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ë§¤ë§¤ ì¤‘ë‹¨?
- **í•´ê²°**: ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ë§¤ë§¤ëŠ” ì§„í–‰ (ë³´ìˆ˜ì  ì ‘ê·¼)

---

## ğŸ“Œ **í•µì‹¬ ì›ì¹™**

1. **API í˜¸ì¶œ ìµœì†Œí™”**: ë©”ì¸ ë£¨í”„ì—ì„œ 1íšŒë§Œ ì¡°íšŒ
2. **ì¶©ëŒ ë°©ì§€**: ë§¤ë„ ì „ ë¯¸ì²´ê²° ë§¤ìˆ˜ ì·¨ì†Œ
3. **ì¤‘ë³µ ë°©ì§€**: ë§¤ìˆ˜ ì „ ë¯¸ì²´ê²° ë§¤ìˆ˜ ì·¨ì†Œ
4. **ì•ˆì „ ìš°ì„ **: ë§¤ë„ ì¤‘ì¸ ì¢…ëª©ì€ ì ˆëŒ€ ë§¤ìˆ˜ ê¸ˆì§€
5. **Graceful Degradation**: ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ì‹œìŠ¤í…œ ì¤‘ë‹¨ ì—†ìŒ
