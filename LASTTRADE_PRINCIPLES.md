# 🚀 LASTTRADE 시스템 개발 대원칙 (Master Principles)

본 문서는 **LASTTRADE** 자동매매 시스템의 설계, 개발 및 운영에 있어 준수해야 할 최우선 원칙을 정의한다.

## 1. 시스템 개요 및 관리 구조
*   **시스템 명칭**: LASTTRADE
*   **데이터 관리**: 모든 생성 및 운용 정보는 **데이터베이스(SQLite)**를 통해 통합 관리한다.
*   **환경 설정**: 웹 대시보드(Board) 또는 텔레그램(Telegram)을 통하여 모든 매매 팩터들을 실시간으로 제어하고 관리한다.
*   **팩터 활용**: 시스템 내 관리되는 모든 환경설정 팩터는 실제 매매 로직에 반드시 적용되어야 한다.
*   **모드 전환 및 실행**: 환경설정에서 3종류의 모드(**REAL, PAPER, MOCK**) 중 하나를 선택하고 저장하면, 시스템은 즉시 해당 모드로 실행 또는 재실행되어야 한다.
*   **데이터 로드**: 실행 시 종목보유현황, 미체결현황, 환경설정정보를 로드(LOAD)하여 매수/매도 결정에 반영한다.

## 2. 매수 및 매매 자금 원칙
*   **기본 전략**: 추가매수(Pyramiding/Averaging Down)의 기본 전략은 **'물타기(WATER)'**이다.
*   **자금 할당**: '매매자금비율'이 70이면 순수 예수금의 70%를 총 투자 가용 자금으로 정의한다.
*   **종목 제한**: '목표종목수'가 5로 설정되면, 실시간 보유 종목수는 최대 5개로 제한한다.
*   **종목당 투자액**: 위 자금비율과 목표종목수를 준수하여 종목당 할당 금액을 계산한다.
*   **분할 매수 단계**: '분할매수횟수'가 5로 설정되면, 물타기는 최대 5회까지만 수행한다.
*   **추가 매수 간격**: '추가매수간격'이 4이면, 최초 매수 후 주가가 **-4% 하락**할 때마다 물타기를 수행한다.
*   **매수 수량 계산룰**: 분할 매수 시 투입 비중은 **1:1:2:4:8:16...** (3단계부터 비중 2배 증가) 수열을 준수한다. (5회 시 1:1:2:4:8)

## 3. 매도 및 리스크 관리 원칙
*   **익절(Take Profit)**: '익절수익률'이 10이면 평단가 기준 +10% 상승 시 즉시 매도한다.
*   **상한가 매도**: '상한가매도'가 29.5이면 주가가 +29.5% 도달 시 즉시 매도한다.
*   **기본 손절(Stop Loss)**: (삭제됨: 일반 손절 로직은 시스템에서 완전히 제거되었습니다.)
*   **조기 손절 (Early Stop-Loss)**:
    - 조건: 현재 단계가 '분할매수횟수 - 1' (예: 5단계 중 4단계)일 때.
    - 기준: 4차 매수 시 계좌 수익률은 약 **-2%**로 수렴한다고 정의한다.
    - 실행: 이 -2% 기준선에서 '개별종목손절률'(예: -5%)만큼 '더' 하락하면(즉, -7% 도달 시) 전량 매도한다.
    - 목적: 최종 단계(MAX) 투입 전, 자금을 보호하기 위한 최후의 방어선이다.
*   **미체결 처리 (매도 시)**: 매도 종목 결정 시, 반드시 해당 종목의 **미체결 매수 주문**이 있는지 확인하고, 있다면 **매수 취소 후 매도를 실행**한다.
*   **매수 제한 (미체결 시)**: 특정 종목의 **미체결 매도 주문**이 존재하면, 해당 종목은 추가 매수할 수 없다.
*   **글로벌 손익 제한**: '글로벌손실제한'이 10이면, 전체 계좌 손실액이 설정 자산의 10%에 도달할 경우 모든 종목을 즉시 매도한다.
*   **타임컷(Time-Cut)**: 타임컷이 100, 1이면 매수 후 100분이 경과하고 수익률이 -1% 이하(손실)일 경우 즉시 매도한다.
*   **RSI 관리**: 현재 버전에서는 적용하지 않으며, 향후 고도화 시 적용한다.
*   **트레일링 스탑(TS)**: 수익 구간 진입 시 TS 로직을 최우선적으로 발동하여 이익을 보존한다.
*   **목표 수익 달성**: '일일목표수익금' 달성 시 모든 종목을 매도하고 당일 매매를 종료한다.
*   **재진입 금지**: 매도한 종목은 설정된 '재진입금지시간'이 경과한 후에만 다시 매수할 수 있다.
*   **당일 청산**: '청산시간' 도달 시 보유한 모든 종목을 전량 매도한다.

## 4. 데이터 안전 및 시스템 보호
*   **현재가 0원 방어**: API에서 현재가가 0원으로 수신되는 경우(데이터 오류), 해당 종목의 매수/매도 판단을 중단하고 수익률을 0%로 처리한다.
*   **자동 모드 전환**: 
    - 기본 설정: 09:00에 Mock → Real 자동 전환 (실전 매매 시작)
    - 기본 설정: 15:30에 Real → Mock 자동 전환 (실전 매매 종료)
    - 휴장일(주말/공휴일)에는 자동 전환하지 않음
    - 설정(`auto_mode_switch_enabled`)으로 활성화/비활성화 가능

## 5. 모드별 특이사항
*   **거래 모드**: 운영 환경에 따라 REAL(실전), PAPER(모의), MOCK(가상 시뮬레이션) 중 하나를 선택한다.
*   **가상 변동폭**: '가상변동폭' 설정은 **MOCK 서버**에서만 적용되며 주가 시뮬레이션의 변동성을 제어한다.
*   **검색식 순번**: 키움증권 영웅문에서 설정한 조건검색식 번호를 의미하며, 실시간 종목 발굴의 근거가 된다.
