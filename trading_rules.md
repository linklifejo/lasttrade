# 자동매매 시스템 매매 원칙 및 규칙 (Trading Rules)

## 0. 시스템 정의 (System Definition)
*   본 시스템은 **키움 REST API**를 기반으로 동작하며, **한국투자증권과는 아무런 관계가 없습니다.**
*   지원하는 매매 모드는 다음과 같습니다:
    1.  **키움 실전투자 (Real)**
    2.  **키움 모의투자 (Paper)**
    3.  **내부 MOCK 서버 (Mock)**: 시뮬레이션 및 테스트 전용

현재 시스템에 구현된 매매 로직과 자금 관리 원칙을 정리한 문서입니다. `check_n_buy.py` 및 `rt_search.py`에 구현된 내용을 기반으로 합니다.

## 1. 자금 관리 (Money Management)

### 1.1 총 운용 자산 설정
*   **안전 마진**: 전체 자산(총 평가금액 + 예수금)의 **70%** 만을 주식 매수에 사용합니다. 나머지 30%는 예비비로 남겨둡니다.
    *   `운용 가능 총액 = (총 평가담보금 + 주문 가능 현금) * 0.7`

### 1.2 종목당 할당 금액
*   설정된 **목표 종목 수 (`target_stock_count`)** 에 따라 자금을 균등 배분합니다.
    *   `종목당 할당액 = 운용 가능 총액 / 목표 종목 수`

### 1.3 예수금 방어 로직 (Deposit Check)
*   모든 매수 시도 전, 현재 **주문 가능 현금**이 계획된 **1회 매수 금액의 50%** 미만일 경우 매수를 포기합니다.
    *   목적: 너무 적은 금액으로 자잘하게 매수되는 것을 방지하고, 의미 있는 수량을 확보할 수 있을 때만 진입합니다.

## 2. 분할 매수 전략 (Split Buying)

### 2.1 분할 횟수 설정 (`split_buy_cnt`)
*   `settings.json`의 `split_buy_cnt` 설정에 따라 종목당 할당액을 나누어 진입합니다.

### 2.2 가중치 분할 매수 로직 (1:1:2:2:4:4... 수열)
*   **핵심 원칙**: 분할 횟수에 관계없이 매수 가중치는 반드시 **1:1:2:2:4:4:8:8...** 패턴을 따라야 합니다 (2단계마다 자금이 2배로 증가). 이는 자금의 안정적인 안분을 위한 절대적 원칙입니다.
*   **예시 (3분할 시)**: 가중치 [1, 1, 2] 적용 (총 4등분하여 25%, 25%, 50% 매수)
*   **예시 (5분할 시)**: 가중치 [1, 1, 2, 2, 4] 적용
*   **예시 (10분할 시)**: 가중치 [1, 1, 2, 2, 4, 4, 8, 8, 16, 16] 적용
*   *주의: 함부로 이 수열을 단순화(예: 1, 2, 4, 8...)하거나 임의로 수정하는 것을 엄격히 금지합니다.*

## 3. 매수 진입 및 추가 매수 조건

### 3.1 신규 진입 (New Entry)
*   **보유 종목 수 체크**: 현재 보유 종목 수가 목표(`target_stock_count`) 미만일 때만 신규 종목을 매수합니다.
*   **쿨타임**: 신규 종목 감지 시 **60초** 간의 쿨타임을 가집니다 (빈번한 재진입 방지).

### 3.2 추가 매수 (Add-on / Pyramiding / Averaging)
*   **적용 대상**: 몰빵(Single) 모드, 분산(Distributed) 모드 관계없이 **모든 전략에 공통 적용**됩니다.
*   **매수 한도 체크**: 현재 총 매입금액이 종목당 할당액의 **95%** 를 초과하면 추가 매수를 중단합니다.
*   **전략 타입 (`single_stock_strategy`)**:
    *   **FIRE (불타기)**: 현재 수익률이 목표(`single_stock_rate`, 예: +1%) **이상**일 때 추가 매수
    *   **WATER (물타기)**: 현재 수익률이 목표(`single_stock_rate`, 예: -1%) **이하**일 때 추가 매수
*   **쿨타임**: 보유 중인 종목에 대해서는 기회를 놓치지 않기 위해 **20초**의 짧은 쿨타임을 가집니다.

## 4. 필터링 (Filtering)

### 4.1 RSI 필터
*   `use_rsi_filter` 설정이 켜져(`true`) 있을 경우 동작합니다.
*   **RSI(14) >= 70**: 과매수 구간으로 판단하여 **매수를 스킵**합니다 (고점 추격 매수 방지).

## 5. UI 및 대시보드 관리 원칙 (UI & Dashboard Maintenance)

### 5.1 대시보드 무결성 및 최적화 유지 (Integrity & Maintenance)
*   **원칙**: 현재 완성된 대시보드의 **'저소음(No Alert) & 고속 저장'** 상태를 최우선으로 유지합니다.
*   **역할 및 책임**: 
    1.  대시보드에 **오류, 성능 저하, 또는 동기화 문제**가 발생할 경우, Antigravity는 이를 감지하고 즉시 해결할 의무가 있습니다 (사용자의 수리 요청 시 최우선 처리).
    2.  단, 기존의 UI 디자인이나 사용자 경험(UX)을 크게 바꾸는 '임의적인 변경'은 지양하며, 필요시 반드시 사전 안내 후 진행합니다.

## 요약
이 시스템은 자산의 70% 범위 내에서, 설정된 종목 수만큼 자감을 나누고, 각 종목 안에서도 1:1:2 비율(3분할 시)로 나누어, 예수금이 충분하고 전략 조건(불타기/물타기)이 맞을 때만 체계적으로 매수를 실행하여 리스크를 관리합니다. 또한, 안정화된 대시보드는 최상의 컨디션을 유지하도록 상시 모니터링하고 책임 관리합니다.
