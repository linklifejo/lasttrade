# 자동매매 시스템 매매 원칙 및 규칙 (Trading Rules)

## 0. 시스템 정의 (System Definition)
*   본 시스템은 **키움 REST API**를 기반으로 동작하며, **한국투자증권과는 아무런 관계가 없습니다.**
*   지원하는 매매 모드는 다음과 같습니다:
    1.  **키움 실전투자 (Real)**
    2.  **키움 모의투자 (Paper)**
    3.  **내부 MOCK 서버 (Mock)**: 시뮬레이션 및 테스트 전용

현재 시스템에 구현된 매매 로직과 자금 관리 원칙을 정리한 문서입니다. `check_n_buy.py` 및 `rt_search.py`에 구현된 내용을 기반으로 합니다.

## 1. 자금 관리 (Money Management)

### 1.1 총 운용 자산 설정
*   **안전 마진**: 전체 자산(총 평가금액 + 예수금)의 **70%** 만을 주식 매수에 사용합니다. 나머지 30%는 예비비로 남겨둡니다.
    *   `운용 가능 총액 = (총 평가담보금 + 주문 가능 현금) * 0.7`

### 1.2 종목당 할당 금액
*   설정된 **목표 종목 수 (`target_stock_count`)** 에 따라 자금을 균등 배분합니다.
    *   `종목당 할당액 = 운용 가능 총액 / 목표 종목 수`

### 1.3 예수금 방어 로직 (Deposit Check)
*   모든 매수 시도 전, 현재 **주문 가능 현금**이 계획된 **1회 매수 금액의 50%** 미만일 경우 매수를 포기합니다.
    *   목적: 너무 적은 금액으로 자잘하게 매수되는 것을 방지하고, 의미 있는 수량을 확보할 수 있을 때만 진입합니다.

## 2. 분할 매수 전략 (Split Buying)

### 2.1 분할 횟수 설정 (`split_buy_cnt`)
*   `settings.json`의 `split_buy_cnt` 설정에 따라 종목당 할당액을 나누어 진입합니다.

### 2.2 1:1:2 비율 적용 (3분할 시)
*   **분할 횟수가 3회**로 설정된 경우, 자동으로 **1:1:2 비율** 로직이 적용됩니다.
    *   **1차 매수 (25%)**: 신규 진입 시 할당액의 1/4 매수
    *   **2차 매수 (25%)**: 추가 매수 조건 만족 시 할당액의 1/4 매수
    *   **3차 매수 (50%)**: 추가 매수 조건 만족 시 할당액의 2/4 매수
    *   *시스템은 현재 보유한 매입금액을 기준으로 현재 단계를 자동으로 판단합니다.* (예: 이미 25% 보유 중이면 다음은 25% 매수, 50% 보유 중이면 다음은 50% 매수)

*   **그 외 분할 횟수**: 균등 분할 (예: 2회 시 50%, 50%)

## 3. 매수 진입 및 추가 매수 조건

### 3.1 신규 진입 (New Entry)
*   **보유 종목 수 체크**: 현재 보유 종목 수가 목표(`target_stock_count`) 미만일 때만 신규 종목을 매수합니다.
*   **쿨타임**: 신규 종목 감지 시 **60초** 간의 쿨타임을 가집니다 (빈번한 재진입 방지).

### 3.2 추가 매수 (Add-on / Pyramiding / Averaging)
*   **적용 대상**: 몰빵(Single) 모드, 분산(Distributed) 모드 관계없이 **모든 전략에 공통 적용**됩니다.
*   **매수 한도 체크**: 현재 총 매입금액이 종목당 할당액의 **95%** 를 초과하면 추가 매수를 중단합니다.
*   **전략 타입 (`single_stock_strategy`)**:
    *   **FIRE (불타기)**: 현재 수익률이 목표(`single_stock_rate`, 예: +1%) **이상**일 때 추가 매수
    *   **WATER (물타기)**: 현재 수익률이 목표(`single_stock_rate`, 예: -1%) **이하**일 때 추가 매수
*   **쿨타임**: 보유 중인 종목에 대해서는 기회를 놓치지 않기 위해 **20초**의 짧은 쿨타임을 가집니다.

## 4. 필터링 (Filtering)

### 4.1 RSI 필터
*   `use_rsi_filter` 설정이 켜져(`true`) 있을 경우 동작합니다.
*   **RSI(14) >= 70**: 과매수 구간으로 판단하여 **매수를 스킵**합니다 (고점 추격 매수 방지).

## 요약
이 시스템은 자산의 70% 범위 내에서, 설정된 종목 수만큼 자금을 나누고, 각 종목 안에서도 1:1:2 비율(3분할 시)로 나누어, 예수금이 충분하고 전략 조건(불타기/물타기)이 맞을 때만 체계적으로 매수를 실행하여 리스크를 관리합니다.
