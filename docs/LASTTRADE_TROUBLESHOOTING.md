# 🔧 트러블슈팅 가이드

## 🚨 [월요일 긴급 점검: 2026-01-12] 미체결 조회 함수
*   **리스크**: `kiwoom_adapter.py`에 새로 추가된 `get_outstanding_orders` (미체결 조회) 함수가 실전(Real) API 환경에서 에러를 일으킬 가능성이 있음 (Mock에서만 테스트됨).
*   **증상**: 로그에 `AttributeError` 또는 `API 호출 실패`가 뜨거나, 봇이 주문 전에 멈칫거림.
*   **조치**: 
    1.  `c:\lasttrade\kiwoom_adapter.py` 열기.
    2.  `fn_kt00007` 함수 내부를 `try-except`로 감싸서 무조건 `return []` 하도록 긴급 패치.
    3.  일단 미체결 확인 기능 끄고(봇 안 죽게) 장 마감 후 확인.

---

## 📋 **목차**

1. [매수 관련 문제](#1-매수-관련-문제)
2. [매도 관련 문제](#2-매도-관련-문제)
3. [설정 관련 문제](#3-설정-관련-문제)
4. [API 관련 문제](#4-api-관련-문제)
5. [봇 관련 문제](#5-봇-관련-문제)
6. [긴급 상황 대응](#6-긴급-상황-대응)
7. [로그 분석 방법](#7-로그-분석-방법)

---

## 1. 매수 관련 문제

### ❌ **문제: 매수가 전혀 안 됨**

#### **원인 1: 종목 수 제한 도달**
```
증상:
  - 로그: "보유 종목 수 제한 도달"
  - 현재 보유 종목 수 >= target_stock_count

해결:
  1. 설정에서 target_stock_count 증가
  2. 또는 기존 종목 매도 후 재시도
```

#### **원인 2: 매도 중인 종목**
```
증상:
  - 로그: "[매도 중 종목] {종목코드}: 매수 스킵"
  - stocks_being_sold에 종목 존재

해결:
  1. 매도 완료 대기
  2. 또는 check_internal_status.py로 확인:
     python check_internal_status.py
  3. 비정상 상태면 봇 재시작
```

#### **원인 3: 미체결 매도 주문 존재**
```
증상:
  - 로그: "미체결 매도 주문 존재"
  - outstanding_orders에 매도 주문 있음

해결:
  1. show_outstanding.py로 확인:
     python show_outstanding.py
  2. 미체결 주문 취소:
     python emergency_cancel.py
  3. 재시도
```

#### **원인 4: 예수금 부족**
```
증상:
  - 로그: "예수금 부족"
  - balance < one_shot_amt

해결:
  1. 계좌 잔고 확인
  2. trading_capital_ratio 낮추기 (70% → 50%)
  3. 또는 입금
```

#### **원인 5: 전략 조건 미달**
```
증상 (불타기):
  - 로그: "수익률 +X% 미달 (조건: +3%)"
  - 현재 수익률 < single_stock_rate

증상 (물타기):
  - 로그: "손실률 -X% 미달 (조건: -1%)"
  - 현재 손실률 > -single_stock_rate

해결:
  - 조건 충족 대기
  - 또는 single_stock_rate 조정
```

---

### ❌ **문제: 매수 금액이 이상함**

#### **원인 1: initial_buy_ratio 미적용**
```
증상:
  - 1차 매수 금액이 너무 큼 (예: 200만원 전체)
  - 로그에 "초기 X%" 표시 없음

해결:
  1. DB 확인:
     python check_db_settings.py
  2. initial_buy_ratio 설정 확인
  3. 기본값 10.0으로 설정
  4. 봇 재시작
```

#### **원인 2: split_buy_cnt 설정 오류**
```
증상:
  - 분할 횟수가 예상과 다름
  - cumulative_ratios 계산 이상

해결:
  1. 전략별_설정_팩터_기술서.md 참고
  2. split_buy_cnt 확인:
     - 불타기: 2
     - 물타기: 10
  3. 프리셋 재적용
```

---

### ❌ **문제: 중복 매수 발생**

#### **원인: accumulated_purchase_amt 동기화 실패**
```
증상:
  - 같은 종목 중복 매수
  - 로그: "누적 매수금 업데이트 실패"

해결:
  1. 봇 재시작 (데이터 초기화)
  2. check_internal_status.py로 상태 확인
  3. 필요 시 reset_mock_db.py 실행 (모의투자만)
```

---

## 2. 매도 관련 문제

### ❌ **문제: 매도가 전혀 안 됨**

#### **원인 1: 매도 조건 미달**
```
증상:
  - 로그에 매도 시도 없음
  - 수익률/손실률이 조건 미달

확인:
  1. 현재 수익률 확인
  2. 매도 조건 확인:
     - 상한가: +29.5%
     - 타임컷: 30분 + 1% 미만
     - TS: +1.5% 활성화 → -0.5% 하락
     - 익절: +10%
     - 손절: -5%

해결:
  - 조건 충족 대기
  - 또는 수동 매도 (텔레그램: /sell_all)
```

#### **원인 2: 물타기 매집 중 손절 보호**
```
증상:
  - 손실 중인데 매도 안 됨
  - 로그: "[물타기 보호] 매집 중 손절 스킵"
  - pchs_amt < alloc_per_stock * 0.95

해결:
  - 정상 동작 (의도된 보호 로직)
  - 매집 완료 대기 (10회 분할 완료)
  - 또는 수동 매도
```

#### **원인 3: 미체결 매수 주문 취소 실패**
```
증상:
  - 로그: "미체결 매수 주문 취소 실패"
  - 매도 주문 전송 안 됨

해결:
  1. show_outstanding.py로 확인
  2. emergency_cancel.py로 강제 취소
  3. 재시도
```

---

### ❌ **문제: 손절이 작동 안 함 (물타기)**

#### **원인: 매집 중 손절 보호 로직**
```
증상:
  - 손실률 -10% 도달했는데 매도 안 됨
  - 로그: "[물타기 보호] 매집 중 손절 스킵"

확인:
  1. 현재 매수 금액 확인:
     pchs_amt < alloc_per_stock * 0.95
  2. 매집 완료 여부 확인

해결:
  - 매집 완료 대기 (정상 동작)
  - 또는 수동 매도
  - 또는 전략 변경 (불타기로 전환)
```

---

### ❌ **문제: TS가 작동 안 함**

#### **원인 1: TS 비활성화**
```
증상:
  - 수익 중인데 TS 작동 안 함
  - use_trailing_stop = False

해결:
  1. 설정에서 use_trailing_stop = True
  2. 봇 재시작
```

#### **원인 2: TS 활성화 조건 미달**
```
증상:
  - 수익률 < trailing_stop_activation_rate
  - 예: +1.2% (조건: +1.5%)

해결:
  - 조건 충족 대기
  - 또는 trailing_stop_activation_rate 낮추기
```

#### **원인 3: TS 콜백 조건 미달**
```
증상:
  - 고점 대비 하락률 < trailing_stop_callback_rate
  - 예: 고점 대비 -0.3% (조건: -0.5%)

해결:
  - 조건 충족 대기 (정상 동작)
```

---

## 3. 설정 관련 문제

### ❌ **문제: 설정이 반영 안 됨**

#### **원인 1: DB 저장 실패**
```
증상:
  - UI에서 변경했는데 적용 안 됨
  - 로그에 설정값 변경 없음

해결:
  1. DB 확인:
     python check_db_settings.py
  2. 설정 재저장:
     - UI에서 '💾 설정 저장' 클릭
  3. 봇 재시작
```

#### **원인 2: cached_setting() 미사용**
```
증상:
  - 코드에서 하드코딩된 값 사용
  - get_setting() 대신 상수 사용

해결:
  - 코드 수정 필요 (개발자 문의)
```

#### **원인 3: 봇 재시작 필요**
```
증상:
  - 일부 설정은 초기화 시에만 로드
  - 예: target_stock_count

해결:
  - 봇 재시작:
    python stop.py
    python start.py
```

---

### ❌ **문제: 프리셋이 적용 안 됨**

#### **원인: 프리셋 버튼 클릭 후 저장 안 함**
```
증상:
  - 프리셋 버튼 클릭했는데 변경 안 됨
  - '💾 설정 저장' 클릭 안 함

해결:
  1. 프리셋 버튼 클릭
  2. '💾 설정 저장' 클릭 (필수)
  3. 봇 재시작
```

---

### ❌ **문제: DB 오류 발생**

#### **원인 1: DB 파일 손상**
```
증상:
  - 로그: "database is locked"
  - 또는 "database disk image is malformed"

해결:
  1. 봇 중지
  2. DB 백업:
     copy trading.db trading.db.backup
  3. DB 복구 시도:
     python check_db_debug.py
  4. 실패 시 백업에서 복원
```

#### **원인 2: 동시 접근**
```
증상:
  - 로그: "database is locked"
  - 여러 프로세스가 DB 접근

해결:
  1. 중복 실행 확인:
     tasklist | findstr python
  2. 중복 프로세스 종료
  3. 봇 재시작
```

---

## 4. API 관련 문제

### ❌ **문제: 토큰 발급 실패**

#### **원인 1: 잘못된 API 키**
```
증상:
  - 로그: "유효하지 않은 AppKey입니다"
  - Error Code: EGW00103

해결:
  1. API 키 재확인 (키움증권 사이트)
  2. DB 업데이트:
     python update_api_keys.py
  3. 재시도
```

#### **원인 2: API 호출 제한 (일일 5회)**
```
증상:
  - 로그: "1일 토큰발급 횟수를 초과하였습니다"
  - Error Code: EGW00201

해결:
  - 내일까지 대기
  - 또는 모의투자 모드로 전환
```

---

### ❌ **문제: API 호출 제한 (Error 1700)**

#### **원인: 과도한 API 호출**
```
증상:
  - 로그: "Error 1700"
  - API 호출 빈도 초과

해결:
  1. 자동 재시도 대기 (retry 로직 있음)
  2. 또는 잠시 대기 후 재시작
  3. 반복 시 API 호출 간격 조정 필요
```

---

### ❌ **문제: 연결 오류**

#### **원인 1: 인터넷 연결 끊김**
```
증상:
  - 로그: "Connection Error"
  - 네트워크 불안정

해결:
  1. 인터넷 연결 확인
  2. 재연결 후 봇 재시작
```

#### **원인 2: 키움 API 서버 점검**
```
증상:
  - 로그: "503 Service Unavailable"
  - 키움 서버 점검 중

해결:
  - 점검 종료 대기
  - 키움증권 공지사항 확인
```

---

## 5. 봇 관련 문제

### ❌ **문제: 봇이 시작 안 됨**

#### **원인 1: 중복 실행 방지 (Lock 파일)**
```
증상:
  - 로그: "이미 실행 중입니다"
  - main.lock 파일 존재

해결:
  1. 실행 중인 봇 확인:
     tasklist | findstr python
  2. 없으면 Lock 파일 삭제:
     del main.lock
  3. 재시작
```

#### **원인 2: 모듈 임포트 오류**
```
증상:
  - 로그: "ModuleNotFoundError"
  - 또는 "ImportError"

해결:
  1. 가상환경 활성화 확인:
     .venv\Scripts\activate
  2. 패키지 재설치:
     pip install -r requirements.txt
  3. 재시작
```

#### **원인 3: DB 연결 실패**
```
증상:
  - 로그: "database connection failed"
  - trading.db 파일 없음 또는 손상

해결:
  1. DB 파일 확인:
     dir trading.db
  2. 없으면 재생성 (초기 설정 필요)
  3. 손상되었으면 백업에서 복원
```

---

### ❌ **문제: 봇이 갑자기 멈춤**

#### **원인 1: 예외 발생**
```
증상:
  - 로그에 "Exception" 또는 "Error"
  - 봇 프로세스 종료

해결:
  1. error.log 확인:
     type logs\error_YYYYMMDD.log
  2. 에러 원인 파악
  3. 수정 후 재시작
```

#### **원인 2: 메모리 부족**
```
증상:
  - 로그: "MemoryError"
  - 시스템 메모리 부족

해결:
  1. 다른 프로그램 종료
  2. 봇 재시작
  3. 반복 시 시스템 메모리 증설
```

#### **원인 3: API 토큰 만료**
```
증상:
  - 로그: "토큰 만료"
  - 24시간 경과

해결:
  - 자동 재발급 대기 (자동 처리됨)
  - 또는 수동 재시작
```

---

### ❌ **문제: 봇이 느려짐**

#### **원인 1: 로그 파일 과다**
```
증상:
  - logs 폴더 용량 큼
  - 디스크 I/O 증가

해결:
  1. 오래된 로그 삭제:
     del logs\*_20241201.log
  2. 로그 레벨 조정 (DEBUG → INFO)
```

#### **원인 2: DB 크기 증가**
```
증상:
  - trading.db 파일 크기 큼 (>100MB)
  - 쿼리 속도 저하

해결:
  1. DB 최적화:
     python optimize_db.py
  2. 오래된 데이터 정리
```

---

## 6. 긴급 상황 대응

### 🚨 **긴급: 전량 매도 필요**

#### **방법 1: 텔레그램 명령어**
```
명령어:
  /sell_all

확인:
  - 텔레그램으로 "전량 매도 완료" 메시지 수신
```

#### **방법 2: 스크립트 실행**
```
명령어:
  python sell_all_stocks.py

확인:
  - 로그에 "전량 매도 완료" 표시
```

#### **방법 3: 수동 매도 (키움 HTS)**
```
절차:
  1. 키움 HTS 로그인
  2. 보유 종목 확인
  3. 수동 매도 주문
```

---

### 🚨 **긴급: 봇 강제 종료**

#### **방법 1: stop.py 실행**
```
명령어:
  python stop.py

확인:
  - 봇 프로세스 종료 확인
```

#### **방법 2: 프로세스 강제 종료**
```
명령어:
  1. 프로세스 ID 확인:
     tasklist | findstr python
  
  2. 강제 종료:
     taskkill /F /PID {프로세스ID}

확인:
  - 프로세스 목록에서 사라짐
```

#### **방법 3: Lock 파일 삭제**
```
명령어:
  del main.lock

목적:
  - 중복 실행 방지 해제
```

---

### 🚨 **긴급: DB 복구**

#### **방법 1: 백업에서 복원**
```
절차:
  1. 봇 중지
  2. 현재 DB 백업:
     copy trading.db trading.db.broken
  3. 백업 파일 복원:
     copy trading.db.backup trading.db
  4. 봇 재시작
```

#### **방법 2: DB 재생성**
```
절차:
  1. 봇 중지
  2. 현재 DB 백업:
     move trading.db trading.db.old
  3. 봇 재시작 (자동 생성)
  4. 설정 재입력 필요
```

---

## 7. 로그 분석 방법

### 📊 **로그 파일 위치**

```
일반 로그:
  logs/trading_YYYYMMDD.log

에러 로그:
  logs/error_YYYYMMDD.log

봇 로그 (실시간):
  trading_bot.log
```

---

### 📊 **로그 레벨 이해**

```
DEBUG:
  - 상세한 디버깅 정보
  - 모든 변수 값, 계산 과정

INFO:
  - 일반 정보
  - 매수/매도, 설정 로드 등

WARNING:
  - 경고
  - 예수금 부족, 조건 미달 등

ERROR:
  - 에러
  - API 실패, DB 오류 등

CRITICAL:
  - 치명적 에러
  - 시스템 중단 등
```

---

### 📊 **주요 로그 패턴**

#### **매수 성공**
```
[INFO] [신규 매수 (초기 10%)] 005930: 매수 진행 (목표: 200,000원, 전체 할당: 2,000,000원)
[INFO] [매수 주문 성공] 005930: 주문번호 12345
```

#### **매수 실패**
```
[WARNING] [매도 중 종목] 005930: 매수 스킵
[WARNING] [예수금 부족] 필요: 200,000원, 보유: 100,000원
```

#### **매도 성공**
```
[INFO] [TrailingStop] 005930: 매도 진행 (수익률: +5.3%)
[INFO] [매도 주문 성공] 005930: 주문번호 67890
```

#### **매도 실패**
```
[WARNING] [물타기 보호] 005930: 매집 중 손절 스킵
[ERROR] [매도 주문 실패] 005930: API Error
```

---

### 📊 **로그 검색 방법**

#### **특정 종목 검색**
```
PowerShell:
  Get-Content logs\trading_20251226.log | Select-String "005930"

CMD:
  findstr "005930" logs\trading_20251226.log
```

#### **에러만 검색**
```
PowerShell:
  Get-Content logs\trading_20251226.log | Select-String "ERROR"

CMD:
  findstr "ERROR" logs\trading_20251226.log
```

#### **최근 100줄 확인**
```
PowerShell:
  Get-Content logs\trading_20251226.log -Tail 100

CMD:
  powershell -Command "Get-Content logs\trading_20251226.log -Tail 100"
```

---

## 🎯 **문제 해결 체크리스트**

### **매수 안 될 때:**
```
□ 종목 수 제한 확인
□ stocks_being_sold 확인
□ 미체결 주문 확인
□ 예수금 확인
□ 전략 조건 확인
□ 로그 확인
```

### **매도 안 될 때:**
```
□ 매도 조건 확인
□ 물타기 보호 로직 확인
□ 미체결 매수 주문 확인
□ TS 설정 확인
□ 로그 확인
```

### **설정 반영 안 될 때:**
```
□ DB 저장 확인
□ '💾 설정 저장' 클릭 확인
□ 봇 재시작
□ 로그 확인
```

### **봇 시작 안 될 때:**
```
□ Lock 파일 확인
□ 모듈 임포트 확인
□ DB 연결 확인
□ 로그 확인
```

---

## 📞 **추가 지원**

### **문서 참고:**
```
1. LASTTRADE_STRATEGY_GUIDE.md (전략 상세)
2. SYSTEM_MANUAL.md (시스템 구조)
3. README.md
```

### **스크립트 활용:**
```
상태 확인:
  - check_real_balance_now.py (자산확인)
  - check_db.py (DB설정)
  - inspect_sells.py (매도분석)

긴급 조치:
  - force_sell_max.py (전량매도)
  - stop.py (시스템 종료)
```

---

**마지막 업데이트:** 2026-01-10

**이 가이드로 대부분의 문제를 해결할 수 있습니다. 해결 안 되면 로그를 확인하세요!** 🔍
