# ğŸ“˜ LASTTRADE ì‹œìŠ¤í…œ ë§¤ë‰´ì–¼ (System Architecture Manual)

> **Core Philosophy**: "Server is Server." 
> í•µì‹¬ ë¡œì§ì€ UIì™€ ë…ë¦½ì ìœ¼ë¡œ ì‘ë™í•˜ë©°, ì›ì¹™(Principles)ì„ ìµœìš°ì„ ìœ¼ë¡œ ìˆ˜í–‰í•œë‹¤.

## ğŸ—ºï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

![LASTTRADE System Architecture](images/architecture.png)

### ğŸ“ êµ¬ì¡°ë„ (Mermaid Code)

```mermaid
graph TD
    %% ìŠ¤íƒ€ì¼ ì •ì˜
    classDef server fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef client fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef infra fill:#f5f5f5,stroke:#616161,stroke-width:2px;
    classDef db fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,shape:cylinder;

    subgraph Infrastructure [ğŸ›¡ï¸ Infrastructure (ìš´ì˜/ê´€ë¦¬)]
        direction TB
        START(start.py) --> WD(watchdog.py)
        STOP(stop.py)
    end

    subgraph Server [ğŸ§  Trading Core (Server)]
        direction TB
        BOT(bot.py) --> BUY(check_n_buy.py)
        BOT --> SELL(check_n_sell.py)
        BOT --> OPT(optimize_settings.py)
        BUY --> K(kiwoom_adapter.py)
        SELL --> K
    end

    subgraph Client [ğŸ–¥ï¸ Web Dashboard (Client)]
        direction TB
        WEB(web_server.py) --> RT(rt_search.py) --> UI[Browser / index.html]
    end

    subgraph Voice [ğŸ”Š Voice Support]
        VG(voice_generator.py)
    end

    DB[(trading.db)]

    %% ê´€ê³„ ì •ì˜
    START --> BOT
    START --> WEB
    WD -.->|Heartbeat ê°ì‹œ| BOT
    WD -.->|Heartbeat ê°ì‹œ| WEB
    
    BOT --> VG
    SELL --> VG
    WEB --> VG
    WD --> VG
    
    K -->|Direct Access| DB
    RT -.->|Read Only (Loose Coupling)| DB

    %% í´ë˜ìŠ¤ ì ìš©
    class BOT,BUY,SELL,OPT,K server;
    class WEB,RT,UI client;
    class START,WD,STOP infra;
    class DB db;
```

---

## ğŸ—ï¸ 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (System Architecture)

ì „ì²´ ì‹œìŠ¤í…œì€ **3ê°œì˜ ë…ë¦½ëœ í”„ë¡œì„¸ìŠ¤**ë¡œ êµ¬ë™ë˜ë©°, ê° í”„ë¡œì„¸ìŠ¤ëŠ” ëª…í™•í•œ ì—­í•  ë¶„ë‹´ì„ ê°€ì§‘ë‹ˆë‹¤.

### A. Trading Core (Bot) - `bot.py`
*   **ì—­í• **: ì£¼ì‹ ë§¤ë§¤ë¥¼ ë‹´ë‹¹í•˜ëŠ” **ì§„ì§œ 'ì„œë²„'**.
*   **ê¸°ëŠ¥**: ì¥ ì‹œê°„ ê´€ë¦¬, ë§¤ìˆ˜/ë§¤ë„ ë¡œì§ ìˆ˜í–‰, ìê¸ˆ ê´€ë¦¬, API í†µì‹ .
*   **íŠ¹ì§•**: UIê°€ êº¼ì ¸ ìˆì–´ë„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¬µë¬µíˆ ì›ì¹™ëŒ€ë¡œ ë§¤ë§¤ë¥¼ ìˆ˜í–‰í•¨.

### B. Web Dashboard (Viewer) - `web_server.py`
*   **ì—­í• **: í˜„ì¬ ìƒíƒœë¥¼ ì‹œê°í™”í•˜ëŠ” **'ëª¨ë‹ˆí„°'**.
*   **ê¸°ëŠ¥**: ì‹¤ì‹œê°„ ì”ê³ /ë³´ìœ ì¢…ëª© í‘œì‹œ, ë§¤ë§¤ ë¡œê·¸ ì¶œë ¥, ì„¤ì •ê°’ ë³€ê²½ UI.
*   **íŠ¹ì§•**: íŠ¸ë ˆì´ë”© ì½”ì–´ì— ì§ì ‘ ê°œì…í•˜ì§€ ì•Šê³ , DBì™€ íŒŒì¼ì„ í†µí•´ ë°ì´í„°ë¥¼ ì½ì–´ì„œ ë³´ì—¬ì¤Œ.

### C. AI Guardian (Watchdog) - `watchdog.py`
*   **ì—­í• **: ì‚¬ë ¹ê´€ ë° ìˆ˜í˜¸ì.
*   **ê¸°ëŠ¥**: 
    - `bot.py`ì™€ `web_server.py`ì˜ ìƒì¡´ ì—¬ë¶€ë¥¼ ì‹¤ì‹œê°„ ì²´í¬.
    - **ì§€ëŠ¥í˜• ì—ëŸ¬ ë¶„ì„**: ì—”ì§„ ì¢…ë£Œ ì‹œ ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ ì›ì¸ì„ ìŒì„±ìœ¼ë¡œ ë³´ê³ .
    - **365 ìƒì‹œ ê´€ë¦¬**: ì •ìƒ ì¢…ë£Œ í›„ì—ë„ ì¦‰ì‹œ ì¬ê¸°ë™í•˜ì—¬ ì‹œìŠ¤í…œ ë‹¤ìš´íƒ€ì„ì„ ì œë¡œí™”.
    - **ìƒˆë²½ ìœ ì§€ë³´ìˆ˜**: ë§¤ì¼ ìƒˆë²½ 4ì‹œ DB ìµœì í™”(VACUUM) ë° ë¡œê·¸ ì •ë¦¬ ìˆ˜í–‰.
*   **íŠ¹ì§•**: ìŒì„±TTSë¥¼ í†µí•´ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¸Œë¦¬í•‘í•¨.

---

## ğŸ“‚ 2. ì†ŒìŠ¤ ì½”ë“œ ë¶„ë¥˜ (Source Code Map)

### ğŸ§  í•µì‹¬ ë§¤ë§¤ ì—”ì§„ (Logic & Brain)
ê°€ì¥ ì¤‘ìš”í•œ ë¡œì§ë“¤ì´ ëª¨ì—¬ ìˆëŠ” ì˜ì—­ì…ë‹ˆë‹¤.
*   **`bot.py`**: ì‹œìŠ¤í…œì˜ ë©”ì¸ ë£¨í”„. ì „ì²´ íë¦„ ì œì–´, ëª¨ë“œ ì „í™˜(Real/Mock), ìŠ¤ì¼€ì¤„ë§.
*   **`check_n_buy.py`**: **ë§¤ìˆ˜ íŒë‹¨**. ë¬¼íƒ€ê¸° ë‹¨ê³„ ê³„ì‚°(1:1:2:4), ë¶ˆíƒ€ê¸°, **QuickHunter AI í•„í„°ë§** (3ë¶„ ë‚´ ê¸‰ë“± í™•ë¥  íŒë…).
*   **`ai_hunter_inference.py`**: **[New] AI ê¸‰ë“± íŒë…ê¸°**. í•™ìŠµëœ `QuickHunter_3min.pth` ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë§¤ìˆ˜ ì‹œì ì˜ ì„±ê³µ í™•ë¥ ì„ ì‹¤ì‹œê°„ ì¶”ë¡ .
*   **`check_n_sell.py`**: **ë§¤ë„ íŒë‹¨**. ì¡°ê¸° ì†ì ˆ(4ì°¨), ìµì ˆ, MAX ë‹¨ê³„ ì†ì ˆ, ì¥ ë§ˆê° ì²­ì‚°.
*   **`optimize_settings.py`**: **ìê¸ˆ ìµœì í™”**. ì˜ˆìˆ˜ê¸ˆ ë¶€ì¡± ì‹œ ëª©í‘œ ì¢…ëª© ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì¤„ì—¬ì„œ ë¶„í•  ë§¤ìˆ˜ ì›ì¹™ì„ ì‚¬ìˆ˜í•¨.
*   **`kiwoom_adapter.py`**: **í†µì‹ **. í‚¤ì›€ ì‹¤ì „/ëª¨ì˜íˆ¬ì ë° ìì²´ Mock ì„œë²„ì™€ì˜ í†µì‹ ì„ í‘œì¤€í™”í•˜ì—¬ ì—°ê²°.
*   **`voice_generator.py`**: **ìŒì„± ì¶œë ¥**. PowerShell TTSë¥¼ ì´ìš©í•œ ì‹œìŠ¤í…œ ìƒí™© ë¸Œë¦¬í•‘ ë¼ì´ë¸ŒëŸ¬ë¦¬.

### ğŸ–¥ï¸ ì›¹ ëŒ€ì‹œë³´ë“œ (UI & Client)
ì‚¬ìš©ìê°€ ë³´ëŠ” í™”ë©´ê³¼ ê´€ë ¨ëœ ì˜ì—­ì…ë‹ˆë‹¤.
*   **`web_server.py`**: Flask ì›¹ ì„œë²„ êµ¬ë™.
*   **`rt_search.py`**: ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ ë° Dashboardìš© ë°ì´í„° ê°€ê³µ.
*   **`templates/index.html`**: ë©”ì¸ ëŒ€ì‹œë³´ë“œ í™”ë©´ HTML.
*   **`templates/settings.html`**: ì„¤ì • ë³€ê²½ í™”ë©´ HTML.
*   **`static/script_final.js`**: ê¹œë¹¡ì„ ë°©ì§€, ë°ì´í„° ê°±ì‹  Ajax ì²˜ë¦¬.

### ğŸ’¾ ë°ì´í„° ë° ì„¤ì • (Storage & Config)
*   **`trading.db`**: ëª¨ë“  ê±°ë˜ ë‚´ì—­, ì²´ê²° ê¸°ë¡, ìì‚° ë³€ë™ ë‚´ì—­ì´ ì €ì¥ë˜ëŠ” SQLite DB.
*   **`database.py`**: DB ì—°ê²° ë° ì¿¼ë¦¬ ê´€ë¦¬.
*   **`logic_evolver.py`**: **[Evolver]** AIê°€ ìŠ¤ìŠ¤ë¡œ ì†ŒìŠ¤ ì½”ë“œë¥¼ íŒ¨ì¹˜í•˜ëŠ” í•µì‹¬ ì—”ì§„.
*   **`docs/AI_IMPROVEMENT_PROPOSALS.md`**: **[AI ì œì•ˆì„œ]** AIê°€ ë„ì¶œí•œ ë¡œì§ ê°œì„ ì•ˆ ë° ììœ¨ ìˆ˜ì • ì´ë ¥ ê¸°ë¡.
*   **`LASTTRADE_PRINCIPLES.md`**: **[í—Œë²•]** ë§¤ë§¤ ì›ì¹™, ìê¸ˆ ê´€ë¦¬ ì² í•™ì„ ì •ì˜í•œ ë¬¸ì„œ.
*   **`logger.py`**: ì‹œìŠ¤í…œ ë¡œê·¸ ê´€ë¦¬ (ì¸ì½”ë”© ì²˜ë¦¬ í¬í•¨).

### ğŸš€ ìš´ì˜ ë° ê´€ë¦¬ (Operations)
*   **`start.py`**: **ì‹œìŠ¤í…œ ì‹œì‘ì **. ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ë¦¬í•˜ê³  ì„œë²„ì™€ ì›Œì¹˜ë…ì„ ì‹¤í–‰.
*   **`stop.py`**: ì‹œìŠ¤í…œ ì•ˆì „ ì¢…ë£Œ.
*   **`AUTO_START_365.bat`**: **365ì¼ ë¬´ì¤‘ë‹¨ ê°€ë™**. ìœˆë„ìš° ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ ì‹œìŠ¤í…œì„ ì¼œê³  ê´€ë¦¬í•¨.

---

## âš™ï¸ 3. í•µì‹¬ í”„ë¡œì„¸ìŠ¤ íë¦„ (Workflow)

1.  **ì‹œì‘ (`start.py`)**: 
    *   ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ -> ì›Œì¹˜ë… ì‹¤í–‰ -> ë´‡ ì‹¤í–‰ -> ì›¹ ì„œë²„ ì‹¤í–‰.
2.  **ì´ˆê¸°í™” (`bot.py` Startup)**:
    *   `optimize_settings.py` í˜¸ì¶œ -> ìê¸ˆ ëŒ€ë¹„ ì¢…ëª© ìˆ˜ ìµœì í™” ìˆ˜í–‰.
3.  **ì¥ì¤‘ ë£¨í”„**:
    *   `check_market_timing`: ì¥ ì‹œì‘/ë§ˆê°/íœ´ì¥ ì²´í¬.
    *   `check_n_buy` / `check_n_sell`: ë§¤ìˆ˜/ë§¤ë„ ë¡œì§ ë°˜ë³µ ìˆ˜í–‰.
    *   `watchdog`: ë´‡ì´ ì‚´ì•„ìˆëŠ”ì§€ ê³„ì† ê°ì‹œ.
4.  **ì¥ ë§ˆê°**:
    *   ë³´ìœ  ì¢…ëª© ì¼ê´„ ì²­ì‚° (ì„¤ì •ì— ë”°ë¼).
    *   `train_quick_hunter.py`: **[QuickHunter]** 3ë¶„ ë‚´ 3% ê¸‰ë“± íŒ¨í„´ì„ í•™ìŠµí•˜ëŠ” ì´ˆê²½ëŸ‰ Transformer ëª¨ë¸ í•™ìŠµ ì—”ì§„.
    *   **Incremental Learning (ì¦ë¶„ í•™ìŠµ)**: AI í•™ìŠµì˜ íš¨ìœ¨ì„±ì„ ìœ„í•´, ê¸°ì¡´ ëª¨ë¸(`QuickHunter_3min.pth`)ì— ìµœì‹  ë°ì´í„°(ë‹¹ì¼ ë¶„ë´‰)ë¥¼ ì¶”ê°€í•˜ì—¬ ì§€ì†ì ìœ¼ë¡œ ì§„í™”í•˜ëŠ” ë°©ì‹ ì±„íƒ.
    *   **Logic Evolution (Full-Auto)**: ì„±ê³¼ ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ `logic_evolver.py`ê°€ ì½”ë“œë¥¼ ìë™ íŒ¨ì¹˜.
    *   ìë™ ì¢…ë£Œ.

---

## ğŸ“‚ ë¶€ë¡: ì „ì²´ íŒŒì¼ ìƒì„¸ ë¶„ë¥˜ (File Classification)

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìœ„ì¹˜í•œ íŒŒì¼ë“¤ì˜ ì—­í• ê³¼ ì¤‘ìš”ë„ë¥¼ ë¶„ë¥˜í•œ í‘œì…ë‹ˆë‹¤. ê°œë°œ ë° ìœ ì§€ë³´ìˆ˜ ì‹œ ì°¸ê³ í•˜ì‹­ì‹œì˜¤.

### ğŸŸ¢ 1. ì‹œìŠ¤í…œ í•µì‹¬ íŒŒì¼ (System Operation)
> **[CRITICAL]** ì‹œìŠ¤í…œ êµ¬ë™ì— í•„ìˆ˜ì ì¸ íŒŒì¼ë“¤ì…ë‹ˆë‹¤. í•¨ë¶€ë¡œ ì‚­ì œí•˜ê±°ë‚˜ ì´ë™í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.

| êµ¬ë¶„ | íŒŒì¼ëª… | ì—­í•  |
|:---:|:---|:---|
| **ì‹¤í–‰/ê´€ë¦¬** | `start.py` | ì‹œìŠ¤í…œ ì „ì²´ ì‹œì‘ (Entry Point) |
| | `stop.py` | ì‹œìŠ¤í…œ ì „ì²´ ì¢…ë£Œ |
| | `watchdog.py` | í”„ë¡œì„¸ìŠ¤ ê°ì‹œ ë° ìë™ ì¬ì‹œì‘ |
| | `logger.py` | ë¡œê·¸ ê¸°ë¡ (í•œê¸€ ì²˜ë¦¬) |
| | `config.py` | ì„¤ì • ë° ë¹„ë°€ê°’ ê´€ë¦¬ |
| | `voice_generator.py` | ìƒí™©ë³„ ìŒì„± ë³´ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| | `AUTO_START_365.bat` | ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ |
| **ë§¤ë§¤ ì½”ì–´** | `bot.py` | **ë©”ì¸ ì—”ì§„**. ì¥ ìš´ì˜ ë° ìŠ¤ì¼€ì¤„ë§ |
| (Brain) | `check_n_buy.py` | **ë§¤ìˆ˜/ë¬¼íƒ€ê¸°** ë¡œì§ íŒë‹¨ |
| | `check_n_sell.py` | **ë§¤ë„/ì†ì ˆ/ìµì ˆ** ë¡œì§ íŒë‹¨ |
| | `optimize_settings.py` | ìê¸ˆ ë¶€ì¡± ì‹œ ì¢…ëª© ìˆ˜ ìë™ ìµœì í™” |
| | `kiwoom_adapter.py` | API í†µì‹  ë° ë°ì´í„° í‘œì¤€í™” |
| **ë°ì´í„°** | `database.py` | DB ì…ì¶œë ¥ ê´€ë¦¬ |
| | `database_helpers.py` | DB í—¬í¼ í•¨ìˆ˜ |
| | `candle_manager.py` | ë¶„ë´‰/í‹± ë°ì´í„° ê´€ë¦¬ |
| **ì›¹/UI** | `web_server.py` | ì›¹ ì„œë²„ êµ¬ë™ (Flask) |
| | `rt_search.py` | ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ (ì›¹ ì—°ë™) |

### ğŸŸ¡ 2. ë„êµ¬ ë° ìœ í‹¸ë¦¬í‹° (Tools & Utils)
> í•„ìš”í•  ë•Œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ê±°ë‚˜, íŠ¹ì • ìƒí™©ì—ì„œ í˜¸ì¶œë˜ëŠ” íŒŒì¼ë“¤ì…ë‹ˆë‹¤.

*   **ëª¨ë“œ ì „í™˜**: `switch_to_mock.py`, `switch_to_real.py`, `switch_to_paper.py`, `set_paper_mode.py`
*   **ì´ˆê¸°í™”/ë³µêµ¬**: `init_db.py`, `clean_mac_files.py`, `fix_db.py`, `update_setting_db.py`
*   **í•™ìŠµ/ë¶„ì„**: `learn_daily.py`, `math_analyzer.py`

### ğŸ”´ 3. í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… (Test & Debug)
> ê°œë°œ ê²€ì¦ìš© íŒŒì¼ë“¤ì…ë‹ˆë‹¤. ì‹œìŠ¤í…œ ìš´ì˜ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

*   **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: `test_*.py` (ì˜ˆ: `test_mock_danta.py`, `test_db_insert.py`)
*   **ìƒíƒœ í™•ì¸**: `check_*.py` (ì˜ˆ: `check_real_balance_now.py`, `check_steps.py`)
*   **ê°•ì œ ëª…ë ¹**: `force_*.py` (ì˜ˆ: `force_sell.py`, `force_buy.py`)
*   **ë°ì´í„° ì¡°íšŒ**: `query_*.py`, `inspect_*.py`
